---
- name: Build Simple HTTP Server
  shell: |
      cd /tmp
      nohup python -m SimpleHTTPServer > simplehttpserver.out 2>&1 &
  async: 300
  poll: 0

- name: Make preparation for installation
  shell: |
      cp {{ ansible_path }}/repository/{{ ISOName }} {{ ISOPath }} -f
      cp {{ ansible_path }}/config/centos/* /tmp -f
      mount /tmp/{{ ISOName }} /mnt
      cp /mnt/images/pxeboot/vmlinuz /var/lib/libvirt/boot -f
      cp /mnt/images/pxeboot/initrd.img /var/lib/libvirt/boot -f
      umount /mnt

- name: Prepare to templates
  template: src={{item.src}} dest={{item.dest}}
  with_items:
      - { src: 'install.xml', dest: '/tmp/{{ VMName }}_install.xml' }
      - { src: 'boot.xml', dest: '/tmp/{{ VMName }}_boot.xml' }

- name: Start to install centos
  shell: |
      qemu-img create -f qcow2 /var/lib/libvirt/images/{{ VMName }}.qcow2 10G
      virsh create /tmp/{{ VMName }}_install.xml
      sleep 500
      virsh define /tmp/{{ VMName }}_boot.xml
      virsh start {{ VMName }}
  async: 500
  poll: 0

- name: Waste time
  command: sleep 500
